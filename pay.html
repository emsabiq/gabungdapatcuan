<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>Pembayaran via QRIS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* ==================
       Custom Styles
    ================== */
    :root {
      --custom-primary: #0d6efd;
      --custom-success: #198754;
      --custom-warning: #ffc107;
      --custom-danger: #dc3545;
      --custom-light: #f8f9fa;
      --custom-dark: #212529;
      --custom-muted: #6c757d;
      --font-family-sans-serif: 'Plus Jakarta Sans', sans-serif;
      --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
    }

    body {
      background-color: #f0f2f5;
      font-family: var(--font-family-sans-serif);
      color: var(--custom-dark);
    }

    .main-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
    }

    .card {
      border-radius: 1rem;
      border: none;
      box-shadow: var(--card-shadow);
      overflow: hidden;
    }

    .card-header-custom {
      background-color: var(--custom-primary);
      color: white;
      padding: 1.5rem;
      text-align: center;
    }

    .card-header-custom h3 {
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    
    .form-control {
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
    }
    
    .form-control:focus {
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.2);
      border-color: var(--custom-primary);
    }

    .btn {
      border-radius: 0.5rem;
      padding: 0.75rem 1.25rem;
      font-weight: 600;
    }
    
    /* Section Divider */
    .section-divider {
      display: flex;
      align-items: center;
      text-align: center;
      color: var(--custom-muted);
      font-size: 0.9rem;
      font-weight: 600;
    }
    .section-divider::before,
    .section-divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid #dee2e6;
    }
    .section-divider:not(:empty)::before {
      margin-right: .5em;
    }
    .section-divider:not(:empty)::after {
      margin-left: .5em;
    }

    /* Credential Box */
    .cred-box {
      background-color: var(--custom-light);
      border: 1px dashed #ced4da;
      border-radius: 0.75rem;
    }
    .cred-box .label {
      width: 110px;
      display: inline-block;
      color: var(--custom-muted);
    }
    .cred-box .value {
      font-family: 'Courier New', Courier, monospace;
      font-weight: 600;
      background-color: #e9ecef;
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
    }
    
    /* Status Badge */
    #status {
      font-size: 0.9rem;
      padding: 0.4em 0.8em;
      text-transform: capitalize;
    }
    
    /* Animation */
    .fade-in {
      animation: fadeIn 0.6s ease-in-out forwards;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>

  <script src="./config.js"></script>

 <!-- Meta Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1328311132182013');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1328311132182013&ev=PageView&noscript=1"
/></noscript>
<!-- End Meta Pixel Code -->
</head>
<body>
  <div class="container main-container py-4">
    <div class="row justify-content-center w-100">
      <div class="col-lg-7 col-md-9">
        <div class="card">
          <div class="card-body p-4 p-md-5">
            
            <div class="text-center mb-4">
              <i class="bi bi-qr-code-scan" style="font-size: 3rem; color: var(--custom-primary);"></i>
              <h3 class="fw-bold mt-2">Pembayaran via QRIS</h3>
              <p class="text-muted">Isi data diri untuk membuat pesanan Anda.</p>
            </div>
            
            <form id="form" class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nama Lengkap</label>
                <input id="name" class="form-control" required placeholder="Contoh: Budi Santoso">
              </div>
              <div class="col-md-6">
                <label class="form-label">Kontak (Email/WA)</label>
                <input id="contact" class="form-control" required placeholder="Contoh: 08123...">
              </div>
              <div class="col-12 d-flex gap-2 mt-4">
                <button id="btnPay" class="btn btn-primary w-100" type="submit">
                  <span class="pay-text"><i class="bi bi-credit-card-fill me-2"></i>Bayar Sekarang</span>
                  <span class="pay-spin d-none"><span class="spinner-border spinner-border-sm me-2"></span>Membuat Order…</span>
                </button>
              </div>
              <div class="col-12">
                <div class="form-text text-center">Tombol akan membuka tab baru Midtrans. Jangan tutup halaman ini.</div>
              </div>
            </form>
            
            <div id="orderBox" class="d-none mt-4">
              <div class="section-divider my-4">Status Order</div>
              <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded-3">
                <div>
                  <div class="small text-secondary">Order ID:</div>
                  <div class="fs-6 fw-semibold font-monospace" id="orderId">-</div>
                </div>
                <div class="text-end">
                  <div id="status" class="badge text-bg-secondary">menunggu…</div>
                  <button id="btnStatus" class="btn btn-sm btn-outline-secondary mt-2" type="button" disabled><i class="bi bi-arrow-clockwise"></i> Cek</button>
                </div>
              </div>
            </div>

            <div id="credBox" class="d-none mt-4">
              <div class="section-divider my-4">Kredensial Akun Anda</div>
              <div class="alert alert-warning d-flex align-items-start gap-2 border-0" style="background-color: #fff3cd;">
                <i class="bi bi-exclamation-triangle-fill mt-1 fs-5"></i>
                <div>
                  <strong class="alert-heading">Penting! Simpan Kredensial Anda.</strong><br>
                  Salin atau unduh sebelum melanjutkan. Password tidak akan ditampilkan lagi setelah halaman ini ditutup.
                </div>
              </div>

              <div class="p-3 cred-box">
                <div class="mb-2"><span class="label">Username</span>: <span id="uOut" class="value"></span></div>
                <div><span class="label">Password</span>: <span id="pOut" class="value"></span></div>
                <hr>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                  <button id="btnCopy" class="btn btn-sm btn-outline-primary" type="button"><i class="bi bi-clipboard me-1"></i> Salin</button>
                  <button id="btnSaveTxt" class="btn btn-sm btn-outline-secondary" type="button"><i class="bi bi-download me-1"></i> Unduh (.txt)</button>
                  <button id="btnLoginNow" class="btn btn-sm btn-success ms-auto" type="button" disabled><i class="bi bi-box-arrow-in-right me-1"></i> Login Sekarang</button>
                </div>
              </div>
              <div class="small text-secondary mt-2 text-center">
                Atau login manual di <a href="./login.html" class="link-secondary">halaman Login</a>.
              </div>
            </div>

            <div id="alert" class="alert d-none mt-4" role="alert"></div>
            
          </div>
        </div>

        <div class="text-center mt-4">
          <a href="./login.html" class="small text-decoration-none text-muted">Sudah punya akun? Masuk di sini</a>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ================== Konfigurasi ==================
    const WORKER_URL =
      (window.UMKM_CONFIG && window.UMKM_CONFIG.WORKER_URL) ||
      "https://umkm.msabiq-stan.workers.dev";

    // ================== Helper UI ==================
    const $ = (id) => document.getElementById(id);
    const qs = new URLSearchParams(location.search);

    function setStatus(text, cls) {
      const el = $('status');
      el.textContent = text;
      el.className = 'badge ' + (cls || 'text-bg-secondary');
    }

    function showAlert(type, msg) {
      const a = $('alert');
      const icons = {
        success: 'bi-check-circle-fill',
        warning: 'bi-exclamation-triangle-fill',
        danger: 'bi-x-circle-fill',
        info: 'bi-info-circle-fill'
      };
      const icon = icons[type] || 'bi-info-circle-fill';
      a.className = `alert alert-${type} d-flex align-items-center gap-2`;
      a.innerHTML = `<i class="bi ${icon} fs-5"></i><div>${msg}</div>`;
      a.classList.add('fade-in');
    }
    function hideAlert() {
      $('alert').classList.add('d-none');
      $('alert').classList.remove('fade-in');
    }

    function togglePayLoading(loading) {
      $('btnPay').disabled = loading;
      document.querySelector('.pay-text').classList.toggle('d-none', loading);
      document.querySelector('.pay-spin').classList.toggle('d-none', !loading);
    }

    function savePrefill(name, contact) {
      try {
        localStorage.setItem('umkm_prefill', JSON.stringify({ name, contact }));
      } catch (_) {}
    }

    // ================== API ==================
    async function createOrder(name, contact) {
      const r = await fetch(WORKER_URL + '/create-order', {
        method: 'POST',
        headers: {
          'content-type': 'application/json'
        },
        body: JSON.stringify({
          service_id: 'umkm_basic',
          customer: {
            name,
            contact
          }
        })
      });
      const j = await r.json();
      if (!j.ok) throw new Error(j.error || 'create-order failed');
      return j; // {ok, order_id, redirect_url, amount?, gross_amount? ...}
    }
    async function checkStatus(order_id) {
      const r = await fetch(WORKER_URL + '/status-check', {
        method: 'POST',
        headers: {
          'content-type': 'application/json'
        },
        body: JSON.stringify({ order_id })
      });
      return await r.json();
    }
    async function orderClaim(order_id, contact) {
      const r = await fetch(WORKER_URL + '/?route=order-claim', {
        method: 'POST',
        headers: {
          'content-type': 'application/json'
        },
        body: JSON.stringify({ order_id, contact })
      });
      return await r.json(); // {ok, username, password}
    }
    async function userLogin(username, password) {
      const r = await fetch(WORKER_URL + '/?route=user-login', {
        method: 'POST',
        headers: {
          'content-type': 'application/json'
        },
        body: JSON.stringify({ username, password })
      });
      return await r.json(); // {ok, token}
    }

    // ================== State ==================
    let currentOrderId = '';
    let currentAmount = 0;
    let pollTimer = null;
    let opened = null;
    let lastClaim = { username: '', password: '' };

    // Anti-duplikat event FB
    const _fired = new Set();
    function fbTrackOnce(name, params) {
      try {
        if (_fired.has(name)) return;
        fbq('track', name, params);
        _fired.add(name);
      } catch (_) {}
    }

    function startPolling() {
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(async () => {
        try {
          const st = await checkStatus(currentOrderId);
          const s = String(st.transaction_status || 'unknown').toLowerCase();
          setStatus(s, s === 'settlement' ? 'text-bg-success' : 'text-bg-warning');
          if (s === 'settlement' || (s === 'capture' && (st.fraud_status || '') !== 'challenge') || s === 'success') {
            clearInterval(pollTimer);
            await afterPaid();
          }
        } catch (e) {
          console.warn('poll error', e);
        }
      }, 5000);
    }

    async function afterPaid() {
      // Fire Purchase sekali saja, begitu kami yakin status sudah paid
      fbTrackOnce('Purchase', {
        value: Number(currentAmount || 0),
        currency: 'IDR',
        contents: [{ id: currentOrderId || 'ORDER', quantity: 1 }],
        content_type: 'product'
      });

      try {
        const contact = $('contact').value.trim();
        const claim = await orderClaim(currentOrderId, contact);
        if (!claim.ok) throw new Error(claim.error || 'Klaim akun gagal');

        lastClaim.username = claim.username || '';
        lastClaim.password = claim.password || '';

        $('uOut').textContent = lastClaim.username || '(tersimpan)';
        $('pOut').textContent = lastClaim.password || '(tersimpan)';
        const credBox = $('credBox');
        credBox.classList.remove('d-none');
        credBox.classList.add('fade-in');
        
        $('btnLoginNow').disabled = !(lastClaim.username && lastClaim.password);

        // Opsional: pembuatan akun sukses
        fbTrackOnce('CompleteRegistration');

        showAlert('success', 'Pembayaran sukses! Kredensial telah dibuat.');
        $('credBox').scrollIntoView({ behavior: 'smooth' });
      } catch (e) {
        showAlert('danger', e.message || String(e));
      }
    }

    // ================== Prefill ==================
    (() => {
      const pre = (() => {
        try { return JSON.parse(localStorage.getItem('umkm_prefill') || '{}'); }
        catch (_) { return {}; }
      })();
      $('name').value = qs.get('name') || pre.name || '';
      $('contact').value = qs.get('contact') || pre.contact || '';
    })();

    // ================== Submit Form ==================
    $('form').addEventListener('submit', async (e) => {
      e.preventDefault();
      hideAlert();
      const name = $('name').value.trim();
      const contact = $('contact').value.trim();
      if (!name || !contact) return;

      savePrefill(name, contact);
      togglePayLoading(true);

      // Event iklan: user mulai checkout
      fbTrackOnce('InitiateCheckout');

      try {
        opened = window.open('about:blank', '_blank');
        if (opened && opened.document) {
          try {
            opened.document.write(
              '<!doctype html><title>Membuka Pembayaran…</title>' +
              '<style>html,body{height:100%;margin:0}body{display:flex;align-items:center;justify-content:center;font:16px "Plus Jakarta Sans",system-ui;background:#fff;color:#0b3e3a}' +
              '.sp{width:24px;height:24px;border:4px solid #e5e7eb;border-top-color:#0d6efd;border-radius:50%;animation:spin 1s linear infinite}' +
              '@keyframes spin{to{transform:rotate(360deg)}} .row{display:flex;align-items:center;gap:.8rem}</style>' +
              '<div class="row"><div class="sp"></div><div>Membuka Midtrans…</div></div>'
            );
            opened.document.close();
          } catch (_) {}
        }

        const o = await createOrder(name, contact);

        currentOrderId = o.order_id;
        // Ambil jumlah transaksi bila tersedia dari berbagai kemungkinan field
        currentAmount = Number(
          o.amount || o.gross_amount || (o.data && o.data.amount) ||
          (o.transaction_details && o.transaction_details.gross_amount) ||
          o.total || o.price || 0
        );

        // Opsional: user menambahkan info pembayaran
        fbTrackOnce('AddPaymentInfo');

        $('orderId').textContent = currentOrderId;
        const orderBox = $('orderBox');
        orderBox.classList.remove('d-none');
        orderBox.classList.add('fade-in');
        $('btnStatus').disabled = false;
        setStatus('menunggu pembayaran', 'text-bg-warning');

        if (opened) opened.location.href = o.redirect_url;
        else window.open(o.redirect_url, '_blank');

        startPolling();
      } catch (err) {
        showAlert('danger', err.message || String(err));
        if (opened) try { opened.close(); } catch (_) {}
      } finally {
        togglePayLoading(false);
      }
    });

    // ================== Redirect dari Snap (via finish.html) ==================
    (async () => {
      const qOrder = qs.get('order_id');
      if (qOrder) {
        currentOrderId = qOrder;
        $('orderId').textContent = currentOrderId;
        const orderBox = $('orderBox');
        orderBox.classList.remove('d-none');
        orderBox.classList.add('fade-in');

        const s = (qs.get('transaction_status') || '').toLowerCase();
        if (s === 'settlement' || s === 'success' || (s === 'capture' && (qs.get('fraud_status') || '') !== 'challenge')) {
          setStatus('settlement', 'text-bg-success');
          await afterPaid();
        } else {
          setStatus('memeriksa…', 'text-bg-secondary');
          startPolling();
        }
      }
    })();

    // ================== Cek Status Manual ==================
    $('btnStatus').addEventListener('click', async () => {
      if (!currentOrderId) return;
      $('btnStatus').disabled = true;
      try {
        const st = await checkStatus(currentOrderId);
        const s = String(st.transaction_status || 'unknown').toLowerCase();
        setStatus(s, s === 'settlement' ? 'text-bg-success' : 'text-bg-warning');
        if (s === 'settlement' || (s === 'capture' && (st.fraud_status || '') !== 'challenge') || s === 'success') {
          if (pollTimer) clearInterval(pollTimer);
          await afterPaid();
        }
      } catch (e) {
        showAlert('danger', String(e));
      } finally {
        $('btnStatus').disabled = false;
      }
    });

    // ================== Aksi kredensial ==================
    $('btnCopy').addEventListener('click', async () => {
      const u = $('uOut').textContent || '';
      const p = $('pOut').textContent || '';
      try {
        await navigator.clipboard.writeText(`Username: ${u}\nPassword: ${p}\nOrder ID: ${currentOrderId}`);
        showAlert('success', 'Kredensial disalin ke clipboard.');
      } catch (_) {
        showAlert('warning', 'Gagal menyalin. Silakan salin secara manual.');
      }
    });

    $('btnSaveTxt').addEventListener('click', () => {
      const u = $('uOut').textContent || '';
      const p = $('pOut').textContent || '';
      const blob = new Blob([`Kredensial Akun\n\nUsername: ${u}\nPassword: ${p}\nOrder ID: ${currentOrderId}\n`], {
        type: 'text/plain'
      });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `kredensial-${currentOrderId}.txt`;
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 500);
    });

    // ================== Login Sekarang (manual, one-click) ==================
    $('btnLoginNow').addEventListener('click', async () => {
      const u = lastClaim.username;
      const p = lastClaim.password;
      if (!u || !p) {
        return showAlert('warning', 'Kredensial belum tersedia. Tunggu klaim akun.');
      }
      try {
        const login = await userLogin(u, p);
        if (login.ok && login.token) {
          localStorage.setItem('umkm_token', login.token);
          showAlert('success', 'Login berhasil! Anda akan diarahkan ke Aset Digital, mohon tunggu 5 detik…');
          setTimeout(() => location.href = './akses.html', 1200);
        } else {
          showAlert('warning', 'Akun berhasil dibuat, namun login otomatis gagal. Silakan coba login manual.');
        }
      } catch (e) {
        showAlert('danger', e.message || 'Login gagal. Coba login manual di Halaman Login.');
      }
    });
  </script>
</body>
</html>
